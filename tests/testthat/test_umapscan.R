context("umapscan class functions")

iris_num <- iris[, c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width")]
iris_sup <- iris[, "Species", drop=FALSE]

test_that("new_umapscan with wrong arguments throws error", {
  expect_error(new_umapscan(d = 1:10))
  expect_error(new_umapscan(d = iris_num, data_sup = 1:10))
  expect_error(new_umapscan(d = iris_num, data_sup = iris_sup[-1, ]))
})

test_that("new_umapscan results are ok", {
  us <- new_umapscan(iris_num, data_sup = iris_sup, seed = 1337, scale = FALSE)
  expect_equal(us$data, iris_num)
  expect_equal(us$data_sup, iris_sup)
  expect_equal(dim(us$cluster), c(0, 5))
  expect_equal(dim(us$umap), c(nrow(iris_num), 2))
  set.seed(1337, kind = "default", normal.kind = "default", sample.kind = "default")
  umap <- uwot::umap(iris_num)
  expect_equal(tibble::tibble(x = umap[,1], y = umap[,2]), us$umap)
})

test_that("new_umapscan results with scale=TRUE are ok", {
  us <- new_umapscan(iris_num, data_sup = iris_sup, seed = 24312, scale = TRUE)
  set.seed(24312, kind = "default", normal.kind = "default", sample.kind = "default")
  umap <- uwot::umap(dplyr::mutate_all(iris_num, base::scale))
  expect_equal(tibble::tibble(x = umap[,1], y = umap[,2]), us$umap)
})

test_that("new_umapscan results are reproducible", {
  us <- new_umapscan(iris_num, seed = 24312, scale = TRUE)
  result <- structure(list(x = c(11.6932533257899, 8.48682209032854, 8.94537694989543,
    8.63233807308002, 11.3944929366678, 11.1320853533792, 10.996683944592,
    11.4701933339384, 8.32320755755278, 8.712340491116, 11.347654991807,
    11.2364195941491, 8.43106511748503, 8.48006552493561, 11.011713721317,
    11.2008313597823, 11.1435136618747, 11.5583933959064, 11.0725434932137,
    11.3452551289649, 11.7709458185831, 11.284237380704, 11.1309463605399,
    11.5597234405371, 11.2181220110811, 8.55635273512435, 11.3492282252913,
    11.705346618466, 11.7551334270898, 8.9667453666584, 8.69178678622884,
    11.7427585181045, 11.0610423411481, 10.9764977281044, 8.73274647587698,
    8.8379191624165, 11.7708651922152, 11.2581813018654, 8.51582841429607,
    11.5395932721063, 11.4110236602746, 8.22357325656342, 8.86842654603632,
    11.4530219436469, 11.2236240774519, 8.48862722552256, 11.2302941860474,
    8.92397773900163, 11.2518222717529, 11.4415306580137), y = c(4.32582184307899,
      6.89088896922506, 6.3222512863545, 6.36276616939989, 4.07788702298521,
      3.40000329269828, 5.17873596897967, 5.02346424586375, 6.39071713619119,
      6.94687931185683, 3.72150891466455, 4.96904854537037, 6.76700449747471,
      6.40090640989239, 3.19132465178415, 3.10156111228133, 3.41217265182062,
      4.47297461447579, 3.32718390419867, 3.60708617596377, 4.81358543955574,
      3.6307173896646, 4.46001588484803, 5.00216882231412, 4.96899905715005,
      6.83991149312032, 4.75611563994172, 4.47966466512327, 4.90590131621251,
      6.49350431387249, 6.73955817367622, 4.76323728261668, 3.26854453512417,
      3.15798482663156, 6.79814021915006, 6.86402626696063, 4.69266473027975,
      4.21096398244915, 6.43688085294924, 5.02385925551263, 4.42143499128278,
      6.55537196673917, 6.43362822779334, 4.58597937033648, 3.53632692730365,
      6.74697742762796, 3.54316410518693, 6.51514238248617, 3.56464170478963,
      5.2160293513385)), class = "data.frame", row.names = c(NA, -50L
      ))
  expect_equal(us$umap %>% dplyr::slice(1:50) %>% data.frame, result, tolerance = 0.001)
})

test_that("set.seed is ok", {
  set.seed(556677)
  x <- runif(1)
  expect_equal(x, 0.05051134, tolerance = 0.00000001)
  y <- rnorm(1)
  expect_equal(y, 1.970592, tolerance = 0.000001)
  z <- runif(1)
  expect_equal(z, 0.3479608, tolerance = 0.0000001)
})

test_that("base umapscan with seed is ok", {
  set.seed(82223)
  umap <- uwot::umap(USArrests)
  res <- structure(c(6.74056827903631, 7.06702130028158, 7.61218814281897,
    3.00467725911556, 7.46029641154296, 3.40877913741969, -7.75318863185509,
    6.64283702638345, 7.61033987739851, 3.31537194026793, -6.73325565828031,
    -8.10554454106334, 6.90145989121579, -8.18134460247402, -7.05080611402597,
    -7.79236588862006, -7.88264775161748, 7.12018561088294, -7.48882333699146,
    7.91071872078657, 1.72157433597729, 6.86670841281154, -6.95468045076363,
    7.22160282134839, 2.72385524126149, -8.39893675775665, -8.12706855862888,
    7.22770377715324, -6.63588131772639, 2.06064832998472, 7.5964207332291,
    6.61305609417589, 7.76066054447814, -6.45956766326098, -8.01311593647594,
    1.63281344723756, 2.05764287283559, -8.23773130661214, 2.46385999086189,
    7.22067553103144, -7.52157719034046, 3.28207433639129, 3.07154064359547,
    -8.14709701187902, -6.62139661536058, 1.91669265451245, 1.54363979117557,
    -7.28011449518293, -6.64895023551669, 2.25848090922072, -0.758411036802089,
    0.190588389920082, 0.388333126305049, -4.19434053398985, 0.249834869070017,
    -3.90845508096152, 1.67827996433346, -0.633621742714895, 0.520178744038858,
    -3.73659737874613, 3.86741552370368, 1.88318861376711, -0.291929714606134,
    2.08097420847739, 3.93253423097961, 1.91421107300657, 2.28464293781128,
    -0.552495339698129, 3.42313388003315, 0.556209407674409, -3.73775793258631,
    -0.266797658558266, 3.51667057667147, -0.1527798833217, -4.21958168889128,
    2.18613211178201, 2.48569277196677, -0.500574610134969, 3.60290271925775,
    -3.77426565069801, 0.0884160174076345, -0.0898478846848909, 0.67287278906253,
    3.91925561855728, 1.64836009467968, -4.30046754690687, -4.35515477492102,
    2.42432057069305, -3.93374554950771, 0.326962548042502, 3.29084789092858,
    -3.9484589925371, -3.94387650385159, 1.65317954194465, 3.70084372567573,
    -4.15757764035396, -4.16975892970435, 3.25008217313423, 3.95053813369084,
    -4.06010617843861), .Dim = c(50L, 2L), "`scaled:center`" = c(-1.7535792493861,
      2.13712664937116))
    expect_equivalent(umap, res)

    set.seed(82223)
    umap_pca <- uwot::umap(USArrests, init = "pca")
    res_pca <- structure(c(100.595897714633, 101.389523316593, 101.791750438646,
      12.716143961036, 101.55308095362, 12.967428556623, -63.2491045436398,
      100.630190365926, 102.195016671052, 12.6005835915856, -117.353168222917,
      -62.8201438719237, 100.786083485356, -63.0621289311259, -116.650052713465,
      -63.2081667358315, -62.690110558488, 100.905669579346, -116.996477774157,
      101.859799104107, 12.4303507764125, 101.201264509341, -116.857809098568,
      101.233738254061, 12.9776490618501, -62.6120593713409, -62.8279722756422,
      101.141600071368, -116.858215583042, 12.9470046495011, 101.81252650938,
      100.904638344403, 102.034078246057, -117.117560290849, -63.6939368437094,
      12.8177886620523, 12.567601338244, -63.3851345509858, 12.9377658875664,
      101.563841407568, -117.171136392323, 12.5858038321886, 12.9756591475096,
      -63.569804061346, -117.013039793471, 13.2145001843881, 12.5249928346628,
      -116.953169564566, -116.788134588072, 13.0153543103855, -10.8714957798711,
      -11.0611502432367, -10.3787654559462, 6.76751651511461, -10.0388453094842,
      6.29516199857212, -2.93170559459517, -10.5036075330167, -10.5703169548258,
      6.38866706310634, 9.46791192239827, -3.52411898546008, -10.2404437042352,
      -3.21924089350548, 9.91440330960316, -3.35697411432571, -3.47618701393918,
      -10.6390218364826, 10.5423237349132, -10.6322878136, 7.7177065100921,
      -10.3669326949585, 10.0843159746591, -10.9424409294275, 6.85828718713658,
      -3.26047554256884, -2.97157561670409, -10.0877099111564, 9.61629334606785,
      7.56436624775739, -10.3671467385832, -10.219012717127, -10.7353558987895,
      9.73055880021209, -3.13740335165923, 7.88649630969662, 7.4710148784969,
      -3.14000024344895, 7.33255806259858, -10.7898129649917, 10.728518079634,
      6.77170671647619, 6.50828744262856, -3.37612009974039, 9.91563044532609,
      7.56592841293702, 7.8205102973836, 10.4559445157629, 9.70310141914982,
      7.73093875195639), .Dim = c(50L, 2L), "`scaled:center`" = c(-1.37137894522032,
        3.03234723232748))
    expect_equivalent(umap_pca, res_pca)


  })

test_that("uwot version is the same", {
  uwot_version <- installed.packages()["uwot",]
  res <- c(Package = "uwot",
    Version = "0.1.5", Priority = NA_character_, Depends = "Matrix", Imports = "Rcpp, methods, FNN, RSpectra, RcppAnnoy (>= 0.0.11),\nRcppParallel, irlba",
    LinkingTo = "Rcpp, RcppProgress, RcppParallel, RcppAnnoy, dqrng",
    Suggests = "testthat, covr", Enhances = NA_character_, License = "GPL-3",
    License_is_FOSS = NA_character_, License_restricts_use = NA_character_, OS_type = NA_character_,
    MD5sum = NA_character_, NeedsCompilation = "yes", Built = "3.6.2")
  expect_equal(uwot_version[names(uwot_version) != "LibPath"], res)
  })


